/*** *	WDEF ***/#include <SetUpA4.h>#define	ImageWidth		13		// Größe vom eigenen Windowobjekt (sollte nicht geändert werden)#define	ImageHeight		11#define	ImageWOffset	20		// Offset für ein Item#define	ImageXOffset	ImageWOffset+7	// Offset für das erste eigene Windowobjekt#define	minTitleH		19		// minimale Höhe eines Windowtitels#define	MaxItem			10		// maximale Anzahl der Items#define	wItemHit		128		// Hit-Offset auf das erste Item#define	wItemDraw		128		// Item zeichnen#define	wItemSet		129		// Item in Liste eintragen#define	wItemRect		130		// Itemrechteck errechnenshort		items[MaxItem * 2];	// Liste der ics#-IDsshort		ItemAnz;			// Anzahl der vorhandenen Itemsvoid	DrawBox(register WindowPtr w,Rect r,short item);/*** *	die eigene WDEF-Funktion ***/pascal long		main(short varCode,register WindowPtr w,short message,long param){register long	ret;			// Rückgabewert von der originalen WDEFstatic Handle	WDEFHandle = 0L;// Handle auf die originale WDEF-DateiRect			r;				// Rechteck vom eigenen Windowelementregister short	wBoxDelta;		// Offset für Closer, Fuller, etc.GrafPtr			savePort;register short	i;	RememberA0();	SetUpA4();					// erstmal A4 richtig setzen…	GetPort(&savePort);	SetPort(w);	if (!WDEFHandle) WDEFHandle = RGetResource('WDEF',0);	// Original WDEF laden	if (!*WDEFHandle) LoadResource(WDEFHandle);	HLock(WDEFHandle);	// Original WDEF aufrufen	ret = ((pascal long (*)(short,WindowPtr,short,long))StripAddress(*WDEFHandle))(varCode-2*16,w,message,param);	HUnlock(WDEFHandle);	{ FontInfo f; GrafPtr savePort,wmgrPort;		GetPort(&savePort);		GetWMgrPort(&wmgrPort);		SetPort(wmgrPort);					// im Grafport vom Windowmanager zeichnen		GetFontInfo(&f);		wBoxDelta = (f.ascent + f.descent + 4) | 1;			// Höhe vom Windowtitel ermitteln		if (wBoxDelta < minTitleH) wBoxDelta = minTitleH;		wBoxDelta = (wBoxDelta - ImageHeight - 2)>>1;		// Offset für Closer, Fuller, etc.		SetPort(savePort);	}	SetRect(&r,0,0,ImageWidth,ImageHeight);				// Rechteck vom Item	OffsetRect(&r,ImageXOffset,wBoxDelta + 1);			// in die richtige Position schieben	OffsetRect(&r,(*((WindowPeek)w)->strucRgn)->rgnBBox.left,				  (*((WindowPeek)w)->strucRgn)->rgnBBox.top); // in globale Koordinaten umrechnen	switch(message) {	case wNew:	ItemAnz = 0;							// Itemanzahl erstmal = 0				break;	case wDraw:	if (!((WindowPeek)w)->visible) break;	// Window unsichtbar? => raus				if (!((WindowPeek)w)->hilited) break;	// Window nicht hilited? => raus				for(i=0;i<ItemAnz;i++) {				// alle Items zeichnen					DrawBox(w,r,items[i<<1]);			// Image auf den Mover blitten					OffsetRect(&r,ImageWOffset,0);		// Offset auf das nächste Rechteck				}				break;	case wHit:	if (wInDrag != ret) break;				// nicht in Dragbox geklickt?				if (!((WindowPeek)w)->hilited) break;	// Window nicht hilited?				if (!StillDown()) break;				// Maustaste nicht gedrückt?				OffsetRect(&r,1,1); r.right -= 2;		// Ränder abschneiden				for(i=0;i<ItemAnz;i++) {					if (PtInRect(*(Point*)&param,&r)) {	// im Rechteck?						ret = wItemHit - 2 + i;			// angeklicktes Item gefunden						break;					}					OffsetRect(&r,ImageWOffset,0);		// Offset auf das nächste Rechteck				}				break;	case wItemDraw:				if (!((WindowPeek)w)->visible) break;	// Window unsichtbar? => raus				if (!((WindowPeek)w)->hilited) break;	// Window nicht hilited? => raus				i = LoWord(param) - wItemHit;				OffsetRect(&r,ImageWOffset * i,0);		// Offset auf das nächste Rechteck				DrawBox(w,r,items[(i<<1) + HiWord(param)]); // Image auf den Mover blitten				break;	case wItemSet:				((long*)items)[ItemAnz] = param;		// beide Item-IDs setzen				ret = wItemHit + ItemAnz++;				// Item				break;	case wItemRect:				i = ((Rect*)param)->top - wItemHit;				OffsetRect(&r,ImageWOffset * i,0);		// Offset auf das nächste Rechteck				*(Rect*)param = r;						// Rechteck übertragen				break;	}	SetPort(savePort);	RestoreA4();	return(ret);}/*** *	eigenes Windowelement zeichnen ***/void	DrawBox(register WindowPtr w,Rect r,short item){GrafPtr			wmgrPort;GrafPtr			savePort;RgnHandle		saveClip;static BitMap	BoxBitmap;	// BitMap für das eigenen Windowelementregister Handle	h;	GetPort(&savePort);	GetWMgrPort(&wmgrPort);	SetPort(wmgrPort);					// im Grafport vom Windowmanager zeichnen	saveClip = NewRgn();	if (saveClip) {		GetClip(saveClip);				// gerettetes Clipping		SetClip(GrayRgn);		ClipAbove(w);					// Clipping setzen	}	SetRect(&BoxBitmap.bounds,0,0,ImageWidth,ImageHeight);	h = GetResource('ics#',item);		// kleines Icon einlesen	if (h) {		HLock(h);		BoxBitmap.rowBytes = 2;			// 2 Byte Zeilenbreite		BoxBitmap.baseAddr = *h;		// Adresse der Icon-Daten		CopyBits(&BoxBitmap,&wmgrPort->portBits,&BoxBitmap.bounds,&r,srcCopy,nil);		HUnlock(h);		ReleaseResource(h);	} else {		InvertRect(&r);					// Icon nicht gefunden => invertieren	}	if (saveClip) {		SetClip(saveClip);		DisposeRgn(saveClip);	}	SetPort(savePort);}