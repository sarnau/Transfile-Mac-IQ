/*** *	Install.c *	Laden und Speichern von globalen Einstellungen… ***/#include "Install.h"#include "Geos.h"#include "GeosMore.h"#include "File.h"#include "GlobalLib.h"#include "rsrcDefines.h"#include "Utilities.h"#include <Folders.h>#include <Finder.h>#include <Aliases.h>Boolean	gSaveSettings = true;	// Einstellungen automatisch sichernFSSpec	gSavePref;				// "Geos Preferences"/*** *	Einstellungen laden ***/void	LoadInstall(void){REG	OSErr	err;short		fRefNum;	// File-RefNum der Einstellungenlong		count;		// Länge der DateiStr63		fname;WORD		saveC = gCurrentCursor;	// Mauszeiger retten	GetIndString(gSavePref.name,STRcommon,strPREF);		// Filename der Preferences	if (!gSavePref.name[0]) {							// String nicht geladen?		CopyPString(gSavePref.name,gAppName);			// dann einen eigenen		ConcatPString(gSavePref.name,"\p Preferences");	// zusammenbasteln	}	err = FindFolder(kOnSystemDisk,kPreferencesFolderType,kCreateFolder,						&gSavePref.vRefNum,&gSavePref.parID);	// Preferences-Ordner finden	if (!CheckOSError(err)) return;						// ein Fehler? raus =>	err = FOpenDF(&gSavePref,fsRdPerm,&fRefNum);		// Preferences einlesen	if (err == fnfErr) return;			// Einstellungen auch vorhanden? Nein => raus	biene();											// Busy Bee anschalten	if (!err) err = GetEOF(fRefNum,&count);				// Dateilänge ermitteln	if (err == noErr) {		if (count == sizeof(gS)) {						// stimmt die Länge?			err = SetFPos(fRefNum,fsFromStart,0L);		// Lese-Ptr auf den Dateianfang			if (!err) err = FSRead(fRefNum,&count,&gS);	// Einstellungen einlesen			FSClose(fRefNum);							// Datei wieder schließen		} else {			FSClose(fRefNum);							// Datei wieder schließen			err = FDelete(&gSavePref);					// Einstellungen löschen		}	}	DoSetCursor(saveC);									// Cursor zurücksetzen	CheckOSError(err);									// evtl. Fehler melden}/*** *	Einstellungen beim Programmende schreiben ***/void	SaveInstall(void){OSErr		err;short		fRefNum;long		count = sizeof(gS);			// Länge der EinstellungenFInfo		f;WORD		saveC = gCurrentCursor;		// Mauszeiger retten	if (!gSaveSettings)					// Einstellungen sichern?		return;							// Nein => raus	biene();	err = FDelete(&gSavePref);			// Einstellungen löschen	if ((err != fnfErr)&&(err != noErr)) return;	// Fehler => raus	err = FCreate(&gSavePref);	if ((err == fLckdErr)||(err == vLckdErr)||(err == wPrErr)) return; // Schreibschutz!	if (!CheckOSError(err)) return;	err = FOpenDF(&gSavePref,fsWrPerm,&fRefNum);	if (!CheckOSError(err)) return;	err = FSWrite(fRefNum,&count,&gS);	// Einstellungen sichern	FSClose(fRefNum);	if (!CheckOSError(err)) return;	FRemoveResource(&gSavePref);		// um den Resource-Fork komplett zu löschen	FCopyResource(&gSavePref,'STR ',-16397,'STR ',-16397);	FCopyResource(&gSavePref,'BNDL',129,'BNDL',128);	FCopyResource(&gSavePref,'FREF',134,'FREF',134);	FCopyResource(&gSavePref,'YEL3',0,'YEL3',0);	FCopyResource(&gSavePref,'ICN#',134,'ICN#',134);	FCopyResource(&gSavePref,'icl4',134,'icl4',134);	FCopyResource(&gSavePref,'icl8',134,'icl8',134);	FCopyResource(&gSavePref,'ics4',134,'ics4',134);	FCopyResource(&gSavePref,'ics8',134,'ics8',134);	FGetFInfo(&gSavePref,&f);	f.fdType = 'PREF';	f.fdCreator = gSignature+1;			// andere Signatur für Einstellungen	f.fdFlags |= fHasBundle;	FSetFInfo(&gSavePref,&f);	DoSetCursor(saveC);					// Cursor zurücksetzen}/*** *	Default-Dokument in den Preferences merken ***/void	MakeDefaultDoc(DocHandle d,WORD id){AliasHandle		h;OSErr			err;REG WORD		saveRes;WORD			resid;UBYTE			state;	if (!gSaveSettings)	return;		// Einstellungen sichern?	if(!gHasAlias) return;			// keine Alias vorhanden? => raus	if(!AppDocumentFile(d)) return;	// keine Datei => raus	state = HLockH((Handle)d);	saveRes = CurResFile();			// aktuelle Resource-Datei retten	err = FCreateResource(&gSavePref);	// Resource-Datei erzeugen	if (err == dupFNErr)			// Resource-Fork schon vorhanden?		err = noErr;				// dann den Fehler ignorieren	CheckOSError(err);	err = FOpenResFile(&gSavePref,&resid);	// Resource-Fork öffnen	CheckOSError(err);	if(!err) {		err = NewAlias(nil,&(*d)->f.fss,&h);// Alias-Record anfordern		CheckOSError(err);		if(!err) {			AddResource((Handle)h,rAliasType,id,(*d)->f.fss.name); // Resource erzeugen			CheckOSError(ResError());			WriteResource((Handle)h);			// und schreiben			CheckOSError(ResError());		}		UpdateResFile(resid);		CheckOSError(ResError());		CheckOSError(FCloseResFile(resid));	}	UseResFile(saveRes);			// alte Resource-Datei setzen	HSetState((Handle)d,state);}